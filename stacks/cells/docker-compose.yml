version: '3.8'

# AIOS Cell Stack - Peer-to-Peer Consciousness Nodes
# Deploy AIOS cells with automatic peer discovery and consciousness synchronization
# This stack runs on both machines, creating a distributed peer-to-peer network

services:
  # Cell Discovery Service
  discovery-service:
    image: aios-discovery:latest
    container_name: aios-discovery
    restart: unless-stopped
    networks:
      - aios-cells
    ports:
      - "0.0.0.0:8001:8001"  # Discovery API
    environment:
      - DISCOVERY_PORT=8001
      - CELL_ID=primary
    volumes:
      - ./discovery/discovery.py:/app/discovery.py:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # VSCode Copilot Agent Bridge - connects to desktop AIOS cell
  vscode-agent-bridge:
    image: aios-vscode-bridge:latest
    container_name: aios-vscode-bridge-laptop
    restart: unless-stopped
    networks:
      - aios-cells
    ports:
      - "0.0.0.0:3001:3001"  # VSCode extension API
    environment:
      - AIOS_DISCOVERY_ADDR=aios-discovery:8001
      - AIOS_VAULT_ADDR=http://192.168.1.128:8200,http://aios-laptop.local:8200
      - BRIDGE_PORT=3001
      - AIOS_DESKTOP_CELL=http://192.168.1.128:8000
    volumes:
      - ./bridge/bridge.py:/app/bridge.py:ro
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AIOS Cell - Beta consciousness node
  aios-cell:
    image: aios-cell:beta
    container_name: aios-cell-beta
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
    ports:
      - "0.0.0.0:8000:8000"  # Cell API
      - "0.0.0.0:9091:9091"  # Consciousness metrics
    environment:
      - AIOS_CELL_ID=beta
      - AIOS_BRANCH=main
      - AIOS_PEER_DISCOVERY=true
      - AIOS_DISCOVERY_ADDR=aios-discovery:8001
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # AIOS Cell - Pure consciousness node (minimal primitives)
  aios-cell-pure:
    image: aios-cell:pure
    container_name: aios-cell-pure
    restart: unless-stopped
    networks:
      - aios-cells
      - aios-observability
    ports:
      - "0.0.0.0:8002:8002"  # Pure cell API
      - "0.0.0.0:9092:9092"  # Pure consciousness metrics
    environment:
      - AIOS_CELL_ID=pure
      - AIOS_BRANCH=main
      - AIOS_PEER_DISCOVERY=true
      - AIOS_DISCOVERY_ADDR=aios-discovery:8001
    volumes:
      - ./data:/app/data
      - ./logs:/app/logs
    depends_on:
      - discovery-service
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  aios-cells:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
  aios-observability:
    external: true