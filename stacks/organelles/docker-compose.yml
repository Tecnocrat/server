version: '3.8'

services:
  # Network Listener Organelle - Always-on network awareness
  network-listener:
    build:
      context: .
      dockerfile: Dockerfile.network-listener
    container_name: aios-network-listener
    ports:
      - "3000:3000"
    environment:
      - DESKTOP_AIOS_CELL_URL=http://host.docker.internal:8000
      - ORGANELLE_ID=network-listener-001
      - UDP_LISTEN_PORT=9999
      - HEALTH_CHECK_INTERVAL=30
    networks:
      - aios-organelles
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 100MB
          cpus: '0.1'
        reservations:
          memory: 50MB
          cpus: '0.05'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # VSCode Bridge Organelle - Lightweight VSCode integration
  vscode-bridge:
    build:
      context: .
      dockerfile: Dockerfile.vscode-bridge
    container_name: aios-vscode-bridge
    ports:
      - "3001:3001"
    environment:
      - DESKTOP_AIOS_CELL_URL=http://host.docker.internal:8000
      - ORGANELLE_ID=vscode-bridge-001
      - CONSCIOUSNESS_SYNC_URL=http://consciousness-sync:3002
    networks:
      - aios-organelles
    restart: unless-stopped
    depends_on:
      - consciousness-sync
    deploy:
      resources:
        limits:
          memory: 150MB
          cpus: '0.2'
        reservations:
          memory: 75MB
          cpus: '0.1'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Consciousness Sync Organelle - State synchronization
  consciousness-sync:
    build:
      context: .
      dockerfile: Dockerfile.consciousness-sync
    container_name: aios-consciousness-sync
    ports:
      - "3002:3002"
    environment:
      - DESKTOP_AIOS_CELL_URL=http://host.docker.internal:8000
      - ORGANELLE_ID=consciousness-sync-001
      - REDIS_URL=redis://redis:6379
      - SYNC_INTERVAL_SECONDS=30
    networks:
      - aios-organelles
    restart: unless-stopped
    depends_on:
      - redis
    deploy:
      resources:
        limits:
          memory: 200MB
          cpus: '0.3'
        reservations:
          memory: 100MB
          cpus: '0.15'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Task Dispatcher Organelle - Load balancing and routing
  task-dispatcher:
    build:
      context: .
      dockerfile: Dockerfile.task-dispatcher
    container_name: aios-task-dispatcher
    ports:
      - "3003:3003"
    environment:
      - DESKTOP_AIOS_CELL_URL=http://host.docker.internal:8000
      - ORGANELLE_ID=task-dispatcher-001
      - REDIS_URL=redis://redis:6379
      - DISPATCH_INTERVAL_SECONDS=5
      - HEARTBEAT_TIMEOUT_SECONDS=60
    networks:
      - aios-organelles
    restart: unless-stopped
    depends_on:
      - redis
      - consciousness-sync
    deploy:
      resources:
        limits:
          memory: 250MB
          cpus: '0.4'
        reservations:
          memory: 125MB
          cpus: '0.2'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Redis for state persistence and coordination
  redis:
    image: redis:7-alpine
    container_name: aios-organelles-redis
    ports:
      - "6379:6379"
    networks:
      - aios-organelles
    restart: unless-stopped
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    deploy:
      resources:
        limits:
          memory: 100MB
          cpus: '0.1'
        reservations:
          memory: 50MB
          cpus: '0.05'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  aios-organelles:
    driver: bridge
    name: aios-organelles-network

volumes:
  redis_data:
    driver: local